name: publish

on:
  # 手动触发，便于在本地验证通过后再发布
  workflow_dispatch:
  # 推送以 v 开头的标签时自动构建并创建 Release，例如 v0.1.0
  push:
    tags:
      - "v*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-tauri:
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          # 仅缓存 Tauri 后端的 target 目录
          workspaces: "./src-tauri -> target"

      - name: Install frontend dependencies
        # 项目使用 package-lock.json，因此优先使用 npm ci 以获得更稳定的依赖版本
        run: npm ci

      - name: Validate release version and tag
        shell: bash
        run: |
          tauri_version="$(node -e "const fs = require('node:fs'); console.log(JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json','utf8')).version)")"
          npm_version="$(node -e "const fs = require('node:fs'); console.log(JSON.parse(fs.readFileSync('package.json','utf8')).version)")"

          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            if [[ "${GITHUB_REF}" != refs/tags/v* ]]; then
              echo "Manual publish requires selecting a v* tag ref (got: ${GITHUB_REF})" >&2
              exit 1
            fi
          fi

          if [ -z "$tauri_version" ] || [ -z "$npm_version" ]; then
            echo "Failed to read versions from src-tauri/tauri.conf.json and/or package.json" >&2
            exit 1
          fi

          if [ "$tauri_version" != "$npm_version" ]; then
            echo "Version mismatch: src-tauri/tauri.conf.json=$tauri_version, package.json=$npm_version" >&2
            exit 1
          fi

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            expected="v${tauri_version}"
            if [ "${GITHUB_REF_NAME}" != "$expected" ]; then
              echo "Tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected}" >&2
              exit 1
            fi
          fi

      - name: Load curated release notes (bilingual)
        id: release_notes
        shell: bash
        run: |
          file="releases/${GITHUB_REF_NAME}.md"
          if [ ! -f "$file" ]; then
            echo "Missing release notes file: $file" >&2
            echo "Create it (and rewrite it) before tagging, e.g.:" >&2
            echo "  node scripts/generate-release-notes.mjs \"${GITHUB_REF_NAME}\" \"<previousTag>\" > \"$file\"" >&2
            exit 1
          fi

          if ! grep -qE '^##[[:space:]]+English([[:space:]]|$)' "$file"; then
            echo "Release notes must include a '## English' section: $file" >&2
            exit 1
          fi

          if ! grep -qE '^##[[:space:]]+中文([[:space:]]|$)' "$file"; then
            echo "Release notes must include a '## 中文' section: $file" >&2
            exit 1
          fi

          {
            echo "body<<EOF"
            cat "$file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and release with Tauri
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          # GitHub 默认提供的 token，用于创建 Release 与上传构建产物
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # __VERSION__ 会自动替换为 src-tauri/tauri.conf.json 中的 version 字段
          tagName: v__VERSION__
          releaseName: "FFUI v__VERSION__"
          releaseBody: ${{ steps.release_notes.outputs.body }}
          releaseDraft: true
          prerelease: false

      - name: Prepare Windows portable exe asset
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          mkdir -p dist-portable
          src="src-tauri/target/release/ffui.exe"
          if [ ! -f "$src" ]; then
            echo "Portable exe not found: $src" >&2
            exit 1
          fi
          out="dist-portable/FFUI-v${{ steps.tauri.outputs.appVersion }}-windows-x64-portable.exe"
          cp "$src" "$out"
          ls -la dist-portable

      - name: Upload Windows portable exe to release
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.tauri.outputs.appVersion }}
          files: dist-portable/FFUI-v${{ steps.tauri.outputs.appVersion }}-windows-x64-portable.exe
          fail_on_unmatched_files: true

  sync-release-metadata:
    name: sync-release-metadata
    if: startsWith(github.ref, 'refs/tags/v')
    needs: publish-tauri
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync release notes and target commitish
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF_NAME}"
          file="releases/${tag}.md"
          target="$(git rev-parse "${tag}^{commit}")"

          if [ ! -f "$file" ]; then
            echo "Missing release notes file: $file" >&2
            exit 1
          fi

          gh release edit "$tag" \
            --repo "${GITHUB_REPOSITORY}" \
            --notes-file "$file" \
            --target "$target"
