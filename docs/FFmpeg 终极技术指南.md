# FFmpeg 终极技术指南

## A. 核心概念解析

在深入研究具体参数之前，必须理解 FFmpeg 的几个核心工作理念。这些概念是构建高效、精准命令的基础。

### 1. 速率控制 (Rate Control)

速率控制决定了编码器如何分配比特（数据量）来表示视频的每一帧，是平衡**文件大小**与**视频质量**的核心机制。

- **CRF (Constant Rate Factor) / 恒定速率因子**:
  - **适用编码器**: `libx264`, `libx265`, `libsvtav1` 等**软件编码器**。
  - **工作原理**: 追求**感知质量的恒定**。编码器会为复杂的动态画面分配更多比特，为静态画面分配更少比特，以确保整个视频的视觉质量保持在同一水平。这是**单遍编码**中最推荐的模式。
  - **关键点**: 你设定一个质量目标，最终文件大小是不可预测的。数值越低，质量越高，文件越大。

- **CQ (Constant Quality) / 恒定质量**:
  - **适用编码器**: `h264_nvenc`, `hevc_nvenc` 等 **NVIDIA 硬件编码器**。
  - **工作原理**: 功能上对标 CRF，同样追求恒定的输出质量。
  - **关键点**: CQ 的数值与 CRF **没有直接可比性**。例如，`libx264 -crf 23` 的质量大致相当于 `hevc_nvenc -cq 28`。

- **QP (Quantization Parameter) / 量化参数**:
  - **适用编码器**: `h264_amf`, `hevc_amf` 等 **AMD 硬件编码器**，或作为 `constqp` 模式的底层参数。
  - **工作原理**: 为每个宏块（Macroblock）设定一个固定的量化级别。QP 值越低，保留的细节越多，质量越高。它不像 CRF/CQ 那样会根据画面复杂度进行智能调整，因此不常用于最终分发。

- **Global Quality / 全局质量**:
  - **适用编码器**: `h264_qsv`, `hevc_qsv` 等 **Intel 硬件编码器**。
  - **工作原理**: Intel QSV 的质量控制模式，功能上与 CRF/CQ 类似。

- **ABR/CBR/VBR (Average/Constant/Variable Bitrate) / 平均/恒定/可变码率**:
  - **工作原理**: 追求**文件大小或传输速率的可预测性**。
    - **CBR (恒定码率)**: 强制所有时间段的码率保持一致，常用于直播流媒体，但会浪费带宽或牺牲质量。
    - **VBR (可变码率)**: 允许码率在设定的平均值上下浮动，比 CBR 更高效。
    - **2-Pass VBR (两遍编码)**: 第一遍分析视频复杂度并生成统计文件，第二遍根据统计文件精确分配码率。这是在需要**严格控制文件大小**时获得最佳质量的方法。

### 2. Preset (预设) 与 Tune (调优)

- **Preset (预设)**:
  - **功能**: 在**编码速度**与**压缩效率**之间进行权衡。它控制编码器启用哪些算法和分析工具。
  - **影响**: `preset` **越慢**，编码器分析得越精细，就能在同等质量 (CRF) 或同等码率 (-b:v) 下，用**更小的文件体积**来表示视频，但会消耗**更长的处理时间**。它对最终质量的直接影响很小。
  - **示例值**: `ultrafast`, `superfast`, `veryfast`, `medium`, `slow`, `slower`, `veryslow`。

- **Tune (调优)**:
  - **功能**: 根据**视频内容的特性**对编码参数进行微调，以优化特定场景下的视觉效果。
  - **影响**: 它不会显著改变速度或文件大小，但能让编码结果更符合内容的“观感”。
  - **示例值**: `film` (电影), `animation` (动画), `grain` (保留颗粒感), `zerolatency` (零延迟直播)。

### 3. 硬件加速 (Hardware Acceleration)

- **功能**: 利用 GPU (NVIDIA, Intel, AMD) 或专用硬件芯片的编解码能力，极大地提升处理速度。
- **权衡**: 硬件编码速度远超软件编码，但通常在同等码率下，其压缩效率和最终画质略低于精调的软件编码（如 `libx264 -preset slow`）。
- **常见编码器**: `h264_nvenc` (NVIDIA), `hevc_qsv` (Intel), `av1_amf` (AMD), `h264_vaapi` (Linux), `h264_videotoolbox` (Apple)。

### 4. FFmpeg 命令结构

理解参数的作用域至关重要。一个 FFmpeg 命令主要分为几个部分：

`ffmpeg [全局参数] [输入文件参数] -i [输入文件] [输出文件参数] [输出文件]`

- **全局参数 (Global Options)**: 如 `-y` (覆盖输出)，作用于整个 FFmpeg 进程。
- **输入文件参数 (Input File Options)**: 紧跟在 `-i` **之前**的参数，如 `-ss 00:01:00`，作用于其后的输入文件。
- **输出文件参数 (Output File Options)**: 在输入文件之后、输出文件之前的参数，如 `-c:v libx264`，作用于其后的输出文件。

## B. 全局与 I/O 选项

这些选项控制 FFmpeg 的整体行为和文件读写。

| 参数                | 功能描述       | 值域/可选值                                             | 综合推荐/最佳实践                                                                                                                                        | 影响分析                                                          |
| :------------------ | :------------- | :------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- |
| `-y`                | 覆盖输出       | (布尔标志)                                              | 在自动化脚本中必须使用，避免程序因文件已存在而挂起。                                                                                                     | **速度**: 无影响。                                                |
| `-n`                | 禁止覆盖       | (布尔标志)                                              | 在不希望意外覆盖文件时使用。与 `-y` 互斥。                                                                                                               | **速度**: 无影响。                                                |
| `-i <file>`         | 输入文件       | 文件路径/URL                                            | 必需参数，用于指定源文件。可多次使用以添加多个输入。                                                                                                     | **速度**: 无影响。                                                |
| `-ss <time>`        | 寻址 (Seeking) | `HH:MM:SS.ms` 或秒                                      | **最佳实践**: 将 `-ss` 放在 `-i` **之前**。这利用关键帧进行快速寻址，速度极快。若放在 `-i` 之后，FFmpeg 会先解码到指定时间点再开始处理，非常慢但更精确。 | **速度**: 放在 `-i` 前，极大提升剪辑速度。                        |
| `-to <time>`        | 结束时间点     | `HH:MM:SS.ms` 或秒                                      | 指定处理到该时间点结束。同样建议放在 `-i` 之前与 `-ss` 配合使用。                                                                                        | **速度**: 提升剪辑速度。                                          |
| `-t <duration>`     | 持续时间       | `HH:MM:SS.ms` 或秒                                      | 指定从 `-ss` 开始处理的持续时长。                                                                                                                        | **速度**: 提升剪辑速度。                                          |
| `-map <spec>`       | 流映射         | `0:v:0`, `0:a`, `-0:s`                                  | 精确控制哪些流被包含到输出中。`0:v:0` 指第一个输入文件的第一个视频流。`-map 0` 映射所有流。`-map -0:s` 排除所有字幕流。                                  | **速度**: 无影响。                                                |
| `-c <codec>`        | 编解码器       | `copy`, `libx264` 等                                    | `-c:v` (视频), `-c:a` (音频), `-c:s` (字幕)。`copy` 是最强大的选项之一，表示直接复制流数据（转封装），速度最快且无质量损失。                             | **质量/大小/速度**: `copy` 模式下，质量无损，大小不变，速度最快。 |
| `-vn`/`-an`/`-sn`   | 禁用流         | (布尔标志)                                              | 快速禁用视频 (`-vn`)、音频 (`-an`) 或字幕 (`-sn`) 流。是 `-map` 的一种快捷方式。                                                                         | **速度**: 无影响。                                                |
| `-filter_complex`   | 复杂滤镜图     | 滤镜图字符串                                            | 用于处理多个输入/输出的复杂滤镜操作（如画中画、混音）。                                                                                                  | **速度**: 滤镜本身会显著影响处理速度。                            |
| `-hide_banner`      | 隐藏版本信息   | (布尔标志)                                              | 清理命令行输出，使其更易读。                                                                                                                             | **速度**: 无影响。                                                |
| `-loglevel <level>` | 日志级别       | `quiet`, `error`, `warning`, `info`, `verbose`, `debug` | `error` 用于生产环境，`debug` 用于问题排查。                                                                                                             | **速度**: `debug` 或 `trace` 级别可能会因大量 I/O 略微降低速度。  |

## C. 视频参数详解与空间分析

### 1. libx264 (H.264 软件编码器)

**描述**: 质量、兼容性和性能的黄金标准。在追求高质量和高压缩率时，是首选的 H.264 编码器。

#### **`-crf <0-51>`**

- **功能描述**: 恒定速率因子，核心质量控制参数。
- **值域/可选值**: 0 (无损) - 51 (最差)。
- **依赖关系**: `-c:v libx264`。
- **互斥关系**: `-b:v` (码率模式)。
- **综合推荐/最佳实践**:
  - `18-22`: 高质量，视觉上接近无损，适用于存档。
  - `23-24`: **黄金平衡点**，默认值，在质量和文件大小之间取得极佳平衡。
  - `25-28`: 可接受的质量，文件体积更小。
- **影响分析**:
  - **质量**: 数值**越低**，质量**越高**。
  - **大小**: 数值**越低**，大小**越大**。
  - **速度**: 数值**越高**，速度**越快** (编码器需要保留的细节更少)。

#### **`-preset <name>`**

- **功能描述**: 在编码速度和压缩效率间进行权衡。
- **值域/可选值**: `ultrafast`, `superfast`, `veryfast`, `faster`, `fast`, `medium`, `slow`, `slower`, `veryslow`, `placebo`。
- **依赖关系**: `-c:v libx264`。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `medium`: 默认值，最佳平衡。
  - `slow`: 推荐用于高质量压制，压缩效率有明显提升，时间成本可接受。
  - `veryfast`: 适用于快速预览或对速度要求高的场景。
  - `placebo`: **绝对不要使用**，耗时极长，收益微乎其微。
- **影响分析**:
  - **质量**: 对 CRF 模式下的感知质量影响很小。
  - **大小**: 预设**越慢**，文件**越小**。
  - **速度**: 预设**越慢**，速度**极慢**。

#### **`-tune <name>`**

- **功能描述**: 针对特定视频内容优化编码参数。
- **值域/可选值**: `film`, `animation`, `grain`, `stillimage`, `fastdecode`, `zerolatency`。
- **依赖关系**: `-c:v libx264`。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `film`: 适用于真人电影。
  - `animation`: 适用于二维动画，可减少色带。
  - `zerolatency`: 适用于直播流。
- **影响分析**: 对主要指标影响不大，主要改善特定内容的视觉保真度。

#### **`-profile:v <name>`**

- **功能描述**: 设置 H.264 配置文件，以确保与不同设备的兼容性。
- **值域/可选值**: `baseline`, `main`, `high`, `high10`, `high422`, `high444`。
- **依赖关系**: `-c:v libx264`。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `high`: 适用于现代设备（PC, 智能手机, 电视），提供最佳压缩。
  - `main`: 兼容性更广。
  - `baseline`: 适用于非常老旧的设备。
- **影响分析**: 主要影响兼容性，对质量和大小有轻微影响（高级 profile 效率更高）。

---

### 2. hevc_nvenc / h264_nvenc (NVIDIA 硬件编码器)

**描述**: 速度极快，适用于实时录制、直播推流和快速转码。质量略低于同等码率的 `libx264`。

#### **`-cq <0-51>`**

- **功能描述**: 恒定质量，NVENC 的核心质量控制参数。
- **值域/可选值**: 0 (无损) - 51 (最差)。
- **依赖关系**: `-c:v hevc_nvenc` 或 `h264_nvenc`，且 `-rc` 设置为 `vbr` 或 `vbr_hq`。
- **互斥关系**: `-b:v` (码率模式)。
- **综合推荐/最佳实践**: **CQ 值与 CRF 值不可直接对比！**
  - `hevc_nvenc -cq 28`: 视觉质量约等于 `libx265 -crf 24/25`。是日常使用的良好起点。
  - `hevc_nvenc -cq 26`: 适用于对画质要求较高的场景（视觉无损内容）。
  - `h264_nvenc -cq 29`: 视觉质量约等于 `libx264 -crf 24`。
- **影响分析**:
  - **质量**: 数值**越低**，质量**越高**。
  - **大小**: 数值**越低**，大小**越大**。
  - **速度**: 影响较小。

#### **`-preset:v <p1-p7>`**

- **功能描述**: 在编码速度和质量之间进行权衡。
- **值域/可选值**: `p1` (最快) - `p7` (最慢，最高质量)。也支持 `slow`, `medium`, `fast` 等别名。
- **依赖关系**: `_nvenc` 编码器。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `p7`: 最高质量，推荐用于最终输出。
  - `p5` / `p6`: 在质量和速度之间有很好的平衡。
  - `p1` - `p3`: 追求极致速度。
- **影响分析**:
  - **质量**: 预设**越慢**，同等 CQ/码率下质量**越好**。
  - **大小**: 预设**越慢**，文件**越小**。
  - **速度**: 预设**越慢**，速度**越慢**。

#### **`-rc <mode>`**

- **功能描述**: 设置速率控制模式。
- **值域/可选值**: `constqp`, `vbr`, `cbr`, `vbr_hq`。
- **依赖关系**: `_nvenc` 编码器。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `vbr` 或 `vbr_hq`: 配合 `-cq` 使用，用于高质量可变码率编码。
  - `constqp`: 配合 `-qp` 使用，固定量化参数，多用于测试。
  - `cbr`: 配合 `-b:v` 使用，用于直播流。
- **影响分析**: 决定了编码器分配码率的基本逻辑。

#### **高级参数 (源自 VMAF 测试)**

- **`-spatial-aq 1 -temporal-aq 1`**: 启用空间和时间上的自适应量化。`temporal-aq` (时间AQ) 倾向于减小文件大小，而 `spatial-aq` (空间AQ) 倾向于增大文件大小以换取 VMAF 分数。**推荐组合**: `-spatial-aq 0 -temporal-aq 1` 以获得更优的效率。
- **`-rc-lookahead <frames>`**: 前瞻帧数，允许编码器更好地进行码率分配。推荐设置一个值（如 `32`），而不是 `0`。
- **`-b_ref_mode <mode>`**: 允许 B 帧作为参考帧，可以提升压缩效率。推荐设置为 `1` (each) 或 `2` (middle)，需要较新版本的 FFmpeg。

---

### 3. libsvtav1 (AV1 软件编码器)

**描述**: 新一代开源编码标准，压缩效率极高，同等质量下文件体积远小于 H.265 和 H.264。编码过程计算密集，速度较慢。

#### **`-crf <0-63>`**

- **功能描述**: AV1 的核心质量控制参数。
- **值域/可选值**: 0 (无损) - 63 (最差)。
- **依赖关系**: `-c:v libsvtav1`。
- **互斥关系**: `-b:v`。
- **综合推荐/最佳实践**:
  - `crf=32-34`: 视觉质量约等于 `libx264 -crf 23`，是综合推荐的起点。
  - 数值越低，质量越高。
- **影响分析**: 同 `libx264 -crf`。

#### **`-preset <0-13>`**

- **功能描述**: 速度与压缩效率的平衡。**注意：数值越大越快**。
- **值域/可选值**: 0 (最慢) - 13 (最快)。
- **依赖关系**: `-c:v libsvtav1`。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - `4-6`: 官方推荐的平衡点，兼顾存储效率和压制时间。
  - `7-9`: 快速编码场景。
  - `1-3`: 追求极致压缩，非常慢。
- **影响分析**: 同 `libx264 -preset`，但数值方向相反。

#### **`-svtav1-params <key=value>`**

- **功能描述**: 设置 SVT-AV1 特有的编码参数。
- **值域/可选值**: `tune=0` (主观质量模式), `film-grain=8` (去颗粒) 等。
- **综合推荐/最佳实践**:
  - `tune=0`: 启用主观质量模式 (VQ)，会稍微锐化图像，提供更好的心理视觉效果。
  - `film-grain=<0-50>`: 如果源视频有噪点，设置一个较低的值（如 `8`）可以帮助编码器更好地处理，而不是将其视为需要抹除的瑕疵。
- **影响分析**: 微调输出的视觉特性。

## D. 音频参数详解与空间分析

### 1. copy (流复制)

- **功能描述**: 不进行任何重编码，直接将原始音频流从输入文件复制到输出文件。
- **值域/可选值**: `copy`。
- **依赖关系**: `-c:a copy`。
- **互斥关系**: 所有音频滤镜 (`-af`) 和音频编码参数 (`-b:a`, `-ar` 等)。
- **综合推荐/最佳实践**: 在绝大多数视频转码任务中，音频流占用的空间很小，没有必要重编码。**强烈推荐始终使用 `-c:a copy`**，除非有明确的格式转换或音频处理需求。
- **影响分析**:
  - **质量**: **无损**。
  - **大小**: 音频流大小**不变**。
  - **速度**: **最快**，几乎不耗时。

### 2. aac (AAC 编码器)

- **功能描述**: FFmpeg 内置的 AAC 音频编码器，兼容性好。
- **值域/可选值**: (编码器名称)。
- **依赖关系**: `-c:a aac`。
- **互斥关系**: `-c:a copy`。
- **综合推荐/最佳实践**:
  - 使用 `-b:a <bitrate>` 控制码率。
  - `128k`: 可接受的立体声音质。
  - `192k`: 高质量立体声。
  - `320k`: 接近透明的音质。
- **影响分析**:
  - **质量**: 码率越高，质量越好。
  - **大小**: 码率越高，大小越大。
  - **速度**: 编码会增加处理时间，但通常比视频编码快得多。

## E. 核心滤镜系统详解

滤镜通过 `-vf` (视频滤镜) 或 `-af` (音频滤镜) 应用。多个滤镜用逗号分隔形成滤镜链。

### 1. scale (视频缩放)

- **功能描述**: 调整视频分辨率。
- **值域/可选值**: `w=<val>:h=<val>`, `flags=<algo>`, 等。
- **参数详解**:
  - `w` (width), `h` (height): 目标宽度和高度。
    - `-1` 或 `-2`: 自动计算以保持原始宽高比。`-2` 确保结果是偶数，这对于 H.264 等编码器是必需的。
    - 表达式: 支持 `iw` (输入宽度), `ih` (输入高度), `iw/2`, `ih*0.5` 等。
  - `flags`: 指定缩放算法。
    - `bicubic`: 默认，速度和质量的良好平衡。
    - `lanczos`: 高质量缩放，尤其是在缩小分辨率时，能更好地保留锐度。
    - `spline`: 另一种高质量算法。
- **依赖关系**: 无。
- **互斥关系**: 无。
- **综合推荐/最佳实践**:
  - **保持比例缩小到 720p**: `-vf "scale=-2:720:flags=lanczos"`
  - **缩小一半**: `-vf "scale=iw/2:ih/2:flags=lanczos"`
- **影响分析**:
  - **质量**: 缩放是**有损**操作。使用高质量算法 (`lanczos`) 可以减轻质量损失。
  - **大小**: 分辨率越低，文件大小越小。
  - **速度**: 滤镜会增加处理时间，高质量算法比低质量算法慢。

### 2. crop (视频裁剪)

- **功能描述**: 从视频画面中裁剪出一个矩形区域。
- **值域/可选值**: `w:h:x:y`。
- **参数详解**:
  - `w`, `h`: 输出的宽度和高度。
  - `x`, `y`: 裁剪框左上角在原始视频中的坐标。
- **综合推荐/最佳实践**:
  - **裁剪顶部 100 像素**: `-vf "crop=iw:ih-100:0:100"`
  - **自动检测并移除黑边**: `-vf "crop=iw:ih"` 配合 `-cropdetect` 滤镜使用（先检测后应用）。
- **影响分析**: 裁剪本身速度很快，但后续需要重编码。

### 3. subtitles (烧录字幕)

- **功能描述**: 将字幕文件（如 SRT, ASS）硬编码（烧录）到视频帧中，使其成为图像的一部分。
- **值域/可选值**: `filename=<file>:force_style='<style>'`。
- **综合推荐/最佳实践**:
  - **基本烧录**: `-vf "subtitles=mysubs.srt"`
  - **强制样式**: `-vf "subtitles=myannoyingfont.ass:force_style='FontName=Arial,FontSize=24'"`
- **影响分析**: 这是一个重编码过程，会显著增加处理时间。

## F. 常见任务配方 (Recipes)

以下是可直接复制使用的命令，并附带解释。

#### 1. 高质量视频存档 (CPU 软编码)

- **目标**: 在保证极高质量的前提下，尽可能压缩文件体积。
- **命令**:
  ```bash
  ffmpeg -i "input.mp4" -c:v libx264 -preset slow -crf 18 -c:a copy "output_archive.mkv"
  ```
- **解释**:
  - `-c:v libx264`: 使用高质量的 H.264 软件编码器。
  - `-preset slow`: 启用更复杂的算法以提高压缩效率。
  - `-crf 18`: 设定一个非常高的质量目标，视觉上几乎无损。
  - `-c:a copy`: 无损复制音频，节省时间。
  - `.mkv`: MKV 容器兼容性好。

#### 2. 极速视频转码 (NVIDIA GPU 硬编码)

- **目标**: 快速转换视频格式，例如将录制的视频转换为通用格式。
- **命令**:
  ```bash
  ffmpeg -i "input.mkv" -c:v hevc_nvenc -preset p5 -rc vbr -cq 28 -c:a copy "output_fast.mp4"
  ```
- **解释**:
  - `-c:v hevc_nvenc`: 使用 NVIDIA H.265 硬件编码，速度极快。
  - `-preset p5`: 一个平衡速度和质量的硬件预设。
  - `-rc vbr -cq 28`: 使用可变码率下的恒定质量模式，`28` 是一个很好的平衡点。
  - `-c:a copy`: 快速复制音频。

#### 3. 现代高效率压缩 (AV1 软编码)

- **目标**: 获得极致的文件大小，用于网络分发或长期存储。
- **命令**:
  ```bash
  ffmpeg -i "input.mp4" -c:v libsvtav1 -preset 5 -crf 34 -g 240 -svtav1-params tune=0 -c:a copy "output_av1.mkv"
  ```
- **解释**:
  - `-c:v libsvtav1`: 使用 AV1 编码器，压缩率最高。
  - `-preset 5`: 平衡的编码速度。
  - `-crf 34`: 相当于 `libx264 -crf 23` 的质量。
  - `-g 240`: 设置关键帧间隔，有助于提高压缩效率。
  - `-svtav1-params tune=0`: 启用主观质量优化。

#### 4. 视频剪辑 (快速无损)

- **目标**: 从一个长视频中快速剪辑出一个片段，不进行重编码。
- **命令**:
  ```bash
  ffmpeg -ss 00:10:30 -to 00:12:00 -i "long_video.mp4" -c copy "clip.mp4"
  ```
- **解释**:
  - `-ss ... -to ...`: 定义剪辑的开始和结束时间。
  - **关键**: `-ss` 和 `-to` 放在 `-i` **之前**，利用关键帧快速寻址。
  - `-c copy`: 对所有流（视频和音频）进行复制，实现无损、极速剪辑。

#### 5. 调整分辨率并优化网络播放

- **目标**: 将一个 4K 视频缩小到 1080p，并确保其适合在网页上播放。
- **命令**:
  ```bash
  ffmpeg -i "input_4k.mp4" -vf "scale=-2:1080:flags=lanczos" -c:v libx264 -preset medium -crf 23 -c:a copy -movflags +faststart "output_1080p_web.mp4"
  ```
- **解释**:
  - `-vf "scale=-2:1080:flags=lanczos"`: 将视频高度设为 1080，宽度按比例自动调整，并使用高质量的 `lanczos` 算法。
  - `-c:v libx264 ...`: 使用标准参数进行高质量重编码。
  - `-movflags +faststart`: 将 MP4 的元数据（moov atom）移动到文件开头，允许边下载边播放。

## G. 附录：关系与依赖总览

### 1. 硬件加速依赖

| 编码器           | 硬件厂商         | 驱动/系统要求          |
| :--------------- | :--------------- | :--------------------- |
| `*_nvenc`        | NVIDIA           | NVIDIA 官方驱动        |
| `*_qsv`          | Intel            | Intel 驱动 / Media SDK |
| `*_amf`          | AMD              | AMD 官方驱动 (Windows) |
| `*_vaapi`        | Intel/AMD/NVIDIA | VA-API 驱动 (Linux)    |
| `*_videotoolbox` | Apple            | macOS / iOS            |

### 2. 速率控制互斥关系

| 模式              | 核心参数                         | 互斥参数              | 适用场景                                   |
| :---------------- | :------------------------------- | :-------------------- | :----------------------------------------- |
| **质量优先**      | `-crf`, `-cq`, `-global_quality` | `-b:v`, `-pass`       | 存档、本地播放、追求恒定质量。**（首选）** |
| **大小/码率优先** | `-b:v`                           | `-crf`, `-cq`         | 直播、需要精确控制文件大小或传输速率。     |
| **两遍编码**      | `-pass 1`, `-pass 2`             | `-crf`, `-cq`         | 在精确控制文件大小的同时获得最佳质量。     |
| **固定量化**      | `-qp`                            | `-crf`, `-cq`, `-b:v` | 测试、分析。不推荐用于最终输出。           |

### 3. 关键参数依赖

- **`-c copy`**: 当使用此参数时，所有**重编码**相关的参数和**滤镜**都会失效。
- **硬件编码器质量参数**: `-cq` (NVENC), `-global_quality` (QSV), `-qp_i/-qp_p` (AMF) 必须与对应的 `-c:v` 编码器一起使用。
- **`-ss` (寻址)**: 其行为（快速 vs 精确）完全取决于它在命令行中相对于 `-i` 的位置。
- **滤镜 (`-vf`, `-af`)**: 滤镜链的执行是**有顺序的**。例如，`scale,crop` 和 `crop,scale` 的结果可能完全不同。

## H. FFUI 智能预设与内置配方参考

FFUI 在应用内提供了一组“智能预设包”和参数向导配方，这些组合基于本指南的推荐值以及社区实测（包括 `best-ffmpeg-arguments` 等），在质量/体积/速度之间做了相对稳健的权衡。

### 1. 智能硬件预设（Smart Default Pack）

当检测到 NVIDIA GPU 时，FFUI 会优先推荐以下 4 条硬件感知预设（对应内部 ID：`smart-hevc-fast` / `smart-hevc-archive` / `smart-av1-fast` / `smart-av1-archive`）：

- **H.265 Fast NVENC（快速压缩 / 分享场景）**
  - 核心参数：`-c:v hevc_nvenc -rc vbr -cq 28 -preset p5 -g 120 -bf 3 -pix_fmt yuv420p -vf scale=-2:1080`
  - 理由：
    - `cq 28`：综合测试接近 `libx265 -crf 24/25` 的主观质量，是日常分享视频的“甜点区”。
    - `preset p5`：在 Turing/Ampere/Ada 上兼顾速度与效率；比 p1/p2 多启用一部分质量相关算法。
    - `g=120`：约 5 秒 GOP（24–25 fps 视频），提高压缩效率同时控制 seek 代价。
    - `bf=3`：为大多数内容提供更高压缩率，兼容主流播放器。
    - `yuv420p` + `scale=-2:1080`：面向网页/设备播放的通用 1080p 输出。

- **H.265 Archival NVENC（视觉无损归档）**
  - 核心参数：`-c:v hevc_nvenc -rc vbr -cq 20 -preset p7 -g 60 -bf 3 -pix_fmt yuv420p10le`
  - 理由：
    - `cq 20`：对应“接近视觉无损”的 NVENC 档位，适合作为长期归档或高质量中间件。
    - `preset p7`：启用全部质量增强路径，在 RTX 40 系列上仍具备良好速度。
    - `10-bit (yuv420p10le)`：极大降低 banding 风险，与文档中对归档场景的 10bit 推荐一致。
    - `g=60`：更密集的关键帧，提升 seek 体验，适合剪辑/审片。

- **AV1 Fast (SVT)（高压缩比快速压制）**
  - 核心参数：`-c:v libsvtav1 -crf 34 -preset 6 -g 240 -bf 3 -pix_fmt yuv420p10le -vf scale=-2:1080`
  - 理由：
    - `crf 34`：约等于 `libx264 -crf 23` 的视觉质量，但体积显著更小。
    - `preset 6`：在桌面 CPU 上保持可接受速度，压缩效率优于传统 H.264 方案。
    - `g=240`：为 AV1 设计的较长 GOP，有利于压缩效率。
    - `10-bit`：与 HEVC 归档方案保持一致的高质量色彩处理。

- **AV1 Archival (SVT)（视觉无损归档）**
  - 核心参数：`-c:v libsvtav1 -crf 24 -preset 6 -g 240 -bf 3 -pix_fmt yuv420p10le`
  - 理由：
    - `crf 24`：面向“极致画质/体积比”的归档需求，肉眼难以区分与原片差异。
    - 保留 10-bit 与长 GOP 设置，在保证质量的前提下进一步压缩体积。

在 CPU-only 场景（无 NVENC/AV1 硬编码可用）下，上述 4 条预设会自动回退为：

- H.264 快速压制：`libx264 -crf 23 -preset medium -vf scale=-2:1080`
- H.264 归档：`libx264 -crf 18 -preset slow`
- AV1 快速压制 / 归档：仍使用 `libsvtav1`，参数与上述 AV1 预设保持一致。

### 2. 参数向导中的“视觉无损”高级配方

在 FFUI 的参数向导（Parameter Wizard）中，还内置了两条偏向“极致画质”的高级模板，适合作为用户手动加载/微调的起点：

- **H.265 视觉无损归档（NVENC，高级模板）**
  - 示例模板（核心片段）：
    ```bash
    -hide_banner -i INPUT -map 0 \
      -c:v hevc_nvenc -preset:v p7 -profile:v main10 \
      -rc:v constqp -rc-lookahead 1 \
      -spatial-aq 0 -temporal-aq 1 -weighted_pred 0 \
      -init_qpI 20 -init_qpP 20 -init_qpB 24 \
      -qp_cb_offset 10 -qp_cr_offset 11 \
      -b_ref_mode 1 -dpb_size 4 -multipass 1 \
      -g 60 -bf 3 \
      -pix_fmt yuv420p10le \
      -color_range tv -color_primaries bt709 -color_trc bt709 -colorspace bt709 \
      -c:a copy -movflags +faststart \
      OUTPUT
    ```
  - 设计思路：
    - 使用 `constqp` + 手工 `init_qpI/P/B` 和 `qp_*_offset`，将 QP 锁定在 20–24 一带，瞄准视觉无损。
    - `profile main10` + `yuv420p10le` 保证 10-bit 输出，减少梯度丢失。
    - 启用 B 帧参考（`b_ref_mode 1`）和双倍缓冲（`dpb_size`）增强压缩效率。

- **AV1 视觉无损归档（NVENC，高级模板）**
  - 示例模板（核心片段，基于 Ada NVENC 推荐）：
    ```bash
    -i INPUT -map 0 \
      -c:v av1_nvenc -preset p7 -tune hq \
      -rc constqp -qp 18 \
      -pix_fmt p010le \
      -b_ref_mode each -bf 3 \
      -rc-lookahead 32 \
      -spatial-aq 1 -temporal-aq 1 \
      -c:a copy \
      OUTPUT
    ```
  - 设计思路：
    - `constqp + qp 18`：以视觉无损为目标（低于 18 收益递减），且文件体积仍远小于传统 HEVC。
    - `p010le`：保证 10-bit 管线，减少 banding。
    - 开启空间/时间自适应量化和较大的 `rc-lookahead`，在场景切换时智能分配比特。

这两条高级模板在 UI 中通过“从内置方案加载”一键写入预设的高级参数区域，随后仍可按需微调；后端负责在生成最终命令时自动注入 `-progress pipe:2 -nostdin -hide_banner` 等运行时控制参数。
